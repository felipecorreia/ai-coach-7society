"""
üìö FutEnglish Content Database
Base de conhecimento com vocabul√°rio e li√ß√µes de futebol
"""

from typing import Dict, List, Any
import random

class FootballContent:
    """Base de dados do vocabul√°rio de futebol"""
    
    # ============================================
    # ‚öΩ STEP 1 - VOCABUL√ÅRIO B√ÅSICO
    # ============================================
    
    VOCABULARY_BASIC = [
        {
            "id": 1,
            "pt": "Goleiro",
            "en": "Goalkeeper", 
            "pronunciation": "GOAL-kee-per",
            "category": "positions",
            "explanation": "O jogador que defende o gol e pode usar as m√£os dentro da √°rea",
            "example_pt": "O goleiro fez uma defesa incr√≠vel",
            "example_en": "The goalkeeper made an incredible save",
            "tips": "Tamb√©m pode ser chamado de 'keeper' ou 'goalie'"
        },
        {
            "id": 2,
            "pt": "Zagueiro",
            "en": "Defender",
            "pronunciation": "dih-FEN-der", 
            "category": "positions",
            "explanation": "Jogador que atua na defesa para proteger o gol",
            "example_pt": "O zagueiro cortou o ataque advers√°rio",
            "example_en": "The defender stopped the opponent's attack",
            "tips": "Pode ser 'center-back' (zagueiro central) ou 'full-back' (lateral)"
        },
        {
            "id": 3,
            "pt": "Atacante", 
            "en": "Striker",
            "pronunciation": "STRAI-ker",
            "category": "positions",
            "explanation": "Jogador respons√°vel por marcar gols",
            "example_pt": "O atacante balan√ßou as redes",
            "example_en": "The striker scored a goal",
            "tips": "Tamb√©m chamado de 'forward' ou 'center-forward'"
        },
        {
            "id": 4,
            "pt": "Meio-campo",
            "en": "Midfielder", 
            "pronunciation": "MID-feel-der",
            "category": "positions",
            "explanation": "Jogador que atua entre a defesa e o ataque",
            "example_pt": "O meio-campo distribuiu bem o jogo",
            "example_en": "The midfielder distributed the ball well",
            "tips": "Pode ser defensivo, central ou ofensivo"
        },
        {
            "id": 5,
            "pt": "Bola",
            "en": "Ball",
            "pronunciation": "BAWL",
            "category": "equipment", 
            "explanation": "A esfera usada para jogar futebol",
            "example_pt": "A bola saiu pela linha de fundo",
            "example_en": "The ball went out over the goal line",
            "tips": "Sempre use 'the ball', nunca apenas 'ball'"
        },
        {
            "id": 6,
            "pt": "Gol",
            "en": "Goal",
            "pronunciation": "GOHL",
            "category": "actions",
            "explanation": "Quando a bola entra completamente no gol advers√°rio",
            "example_pt": "Foi um gol de placa!",
            "example_en": "It was a spectacular goal!",
            "tips": "Pode ser usado para o ato de marcar ou a estrutura f√≠sica"
        },
        {
            "id": 7,
            "pt": "Passe",
            "en": "Pass",
            "pronunciation": "PAAS",
            "category": "actions",
            "explanation": "A√ß√£o de enviar a bola para um companheiro",
            "example_pt": "Que passe espetacular!",
            "example_en": "What a spectacular pass!",
            "tips": "Pode ser 'short pass' (passe curto) ou 'long pass' (passe longo)"
        },
        {
            "id": 8,
            "pt": "Chute",
            "en": "Shot",
            "pronunciation": "SHAHT",
            "category": "actions",
            "explanation": "A√ß√£o de chutar a bola em dire√ß√£o ao gol",
            "example_pt": "O chute foi para fora",
            "example_en": "The shot went wide",
            "tips": "Tamb√©m pode ser 'kick' para chute em geral"
        },
        {
            "id": 9,
            "pt": "Campo",
            "en": "Field",
            "pronunciation": "FEELD", 
            "category": "field",
            "explanation": "O terreno onde se joga futebol",
            "example_pt": "O campo estava molhado",
            "example_en": "The field was wet",
            "tips": "Tamb√©m chamado de 'pitch' no ingl√™s brit√¢nico"
        },
        {
            "id": 10,
            "pt": "√Årbitro",
            "en": "Referee",
            "pronunciation": "REF-uh-ree",
            "category": "officials",
            "explanation": "O respons√°vel por aplicar as regras do jogo",
            "example_pt": "O √°rbitro marcou p√™nalti",
            "example_en": "The referee awarded a penalty",
            "tips": "Informalmente chamado de 'ref'"
        }
    ]
    
    # ============================================
    # üìù STEP 2 - FRASES EM CONTEXTO  
    # ============================================
    
    VOCABULARY_PHRASES = [
        {
            "id": 11,
            "pt": "O goleiro fez uma defesa",
            "en": "The goalkeeper made a save",
            "category": "game_actions",
            "context": "Quando o goleiro impede um gol",
            "alternative": "The keeper stopped the shot"
        },
        {
            "id": 12, 
            "pt": "O atacante marcou um gol",
            "en": "The striker scored a goal",
            "category": "game_actions",
            "context": "Quando um jogador marca",
            "alternative": "The forward found the net"
        },
        {
            "id": 13,
            "pt": "Foi um passe perfeito",
            "en": "It was a perfect pass", 
            "category": "game_actions",
            "context": "Elogiando um passe bem executado",
            "alternative": "That was an excellent pass"
        },
        {
            "id": 14,
            "pt": "A bola bateu na trave",
            "en": "The ball hit the post",
            "category": "game_events", 
            "context": "Quando a bola acerta a trave",
            "alternative": "The shot struck the goalpost"
        },
        {
            "id": 15,
            "pt": "O time est√° atacando",
            "en": "The team is attacking",
            "category": "game_tactics",
            "context": "Descrevendo a√ß√£o ofensiva",
            "alternative": "The team is on the attack"
        }
    ]
    
    # ============================================
    # üéØ CATEGORIAS E FILTROS
    # ============================================
    
    CATEGORIES = {
        "positions": "Posi√ß√µes",
        "equipment": "Equipamentos", 
        "actions": "A√ß√µes",
        "field": "Campo",
        "officials": "Arbitragem",
        "game_actions": "A√ß√µes de Jogo",
        "game_events": "Eventos",
        "game_tactics": "T√°ticas"
    }
    
    DIFFICULTY_LEVELS = {
        "Iniciante": {"step": 1, "max_lesson": 5},
        "Intermedi√°rio": {"step": 1, "max_lesson": 10}, 
        "Avan√ßado": {"step": 2, "max_lesson": 15}
    }
    
    # ============================================
    # üé≤ DADOS FAKE PARA DEMONSTRA√á√ÉO
    # ============================================
    
    FAKE_PROGRESS_DATA = {
        "total_lessons": 20,
        "vocabulary_learned": [95, 127, 156, 89, 234],  # N√∫meros aleat√≥rios
        "daily_streak": [3, 8, 15, 2, 23],
        "achievements": [
            "üèÜ Mestre do Vocabul√°rio",
            "‚öΩ Craque da Pron√∫ncia", 
            "üéØ Focado",
            "üî• Sequ√™ncia de Ouro",
            "üìö Estudioso",
            "üåü Primeira Liga"
        ]
    }

class LessonManager:
    """Gerenciador de li√ß√µes e progress√£o"""
    
    def __init__(self):
        self.content = FootballContent()
    
    def get_lesson_by_id(self, lesson_id: int) -> Dict[str, Any]:
        """Retorna li√ß√£o espec√≠fica por ID"""
        all_content = self.content.VOCABULARY_BASIC + self.content.VOCABULARY_PHRASES
        
        for item in all_content:
            if item["id"] == lesson_id:
                return item
        
        return None
    
    def get_lessons_by_level(self, level: str) -> List[Dict[str, Any]]:
        """Retorna li√ß√µes apropriadas para o n√≠vel"""
        config = self.content.DIFFICULTY_LEVELS.get(level, {"step": 1, "max_lesson": 5})
        
        if config["step"] == 1:
            return self.content.VOCABULARY_BASIC[:config["max_lesson"]]
        else:
            basic = self.content.VOCABULARY_BASIC
            phrases = self.content.VOCABULARY_PHRASES[:config["max_lesson"] - len(basic)]
            return basic + phrases
    
    def get_random_lesson(self, level: str = "Intermedi√°rio") -> Dict[str, Any]:
        """Retorna li√ß√£o aleat√≥ria baseada no n√≠vel"""
        lessons = self.get_lessons_by_level(level)
        return random.choice(lessons) if lessons else None
    
    def get_next_lesson(self, current_id: int, level: str) -> Dict[str, Any]:
        """Retorna pr√≥xima li√ß√£o baseada na atual"""
        lessons = self.get_lessons_by_level(level)
        
        current_index = None
        for i, lesson in enumerate(lessons):
            if lesson["id"] == current_id:
                current_index = i
                break
        
        if current_index is not None and current_index + 1 < len(lessons):
            return lessons[current_index + 1]
        
        # Se chegou ao fim, volta para primeira ou li√ß√£o aleat√≥ria
        return lessons[0] if lessons else self.get_random_lesson(level)
    
    def get_fake_progress(self, name: str, position: str) -> str:
        """Gera dados fake de progresso para demonstra√ß√£o"""
        data = self.content.FAKE_PROGRESS_DATA
        
        # Seleciona valores aleat√≥rios dos arrays
        vocab_count = random.choice(data["vocabulary_learned"])
        streak = random.choice(data["daily_streak"])
        achievements = random.sample(data["achievements"], 3)
        
        progress_text = f"""
üìä **Estat√≠sticas do {name}:**

‚≠ê N√≠vel: Intermedi√°rio Avan√ßado  
üìö Li√ß√µes Completadas: 15/{data["total_lessons"]}
üéØ Vocabul√°rio Aprendido: {vocab_count} palavras
üî• Sequ√™ncia Atual: {streak} dias
‚öΩ Posi√ß√£o Favorita: {position}

**√öltimas conquistas:**
"""
        
        for achievement in achievements:
            progress_text += f"{achievement}\n"
        
        progress_text += f"\nContinue assim, {name}! Voc√™ t√° voando! üöÄ"
        
        return progress_text

class ContentHelper:
    """Helpers para manipula√ß√£o de conte√∫do"""
    
    @staticmethod
    def clean_text_for_tts(text: str) -> str:
        """Limpa texto para TTS (remove emojis, markdown, etc)"""
        import re
        
        # Remove emojis
        emoji_pattern = re.compile("["
            u"\U0001F600-\U0001F64F"  # emoticons
            u"\U0001F300-\U0001F5FF"  # symbols & pictographs
            u"\U0001F680-\U0001F6FF"  # transport & map symbols
            u"\U0001F1E0-\U0001F1FF"  # flags (iOS)
            u"\U00002702-\U000027B0"
            u"\U000024C2-\U0001F251"
            "]+", flags=re.UNICODE)
        
        text = emoji_pattern.sub(r'', text)
        
        # Remove markdown
        text = re.sub(r'\*\*(.*?)\*\*', r'\1', text)  # **bold**
        text = re.sub(r'\*(.*?)\*', r'\1', text)      # *italic*
        text = re.sub(r'`(.*?)`', r'\1', text)        # `code`
        
        # Remove pontua√ß√£o excessiva
        text = re.sub(r'[!]{2,}', '!', text)
        text = re.sub(r'[?]{2,}', '?', text)
        text = re.sub(r'[.]{2,}', '.', text)
        
        # Limpa espa√ßos
        text = re.sub(r'\s+', ' ', text.strip())
        
        return text
    
    @staticmethod
    def extract_english_words(text: str) -> List[str]:
        """Extrai palavras em ingl√™s do texto para √°udio separado"""
        import re
        
        # Padr√µes para identificar palavras inglesas
        english_patterns = [
            r'\b[A-Za-z]+(?:\s[A-Za-z]+)*\b'  # Palavras b√°sicas
        ]
        
        english_words = []
        for pattern in english_patterns:
            matches = re.findall(pattern, text)
            english_words.extend(matches)
        
        return list(set(english_words))  # Remove duplicatas
    
    @staticmethod
    def format_lesson_text(lesson: Dict[str, Any]) -> str:
        """Formata li√ß√£o para exibi√ß√£o no chat"""
        if not lesson:
            return "Li√ß√£o n√£o encontrada."
        
        text = f"‚öΩ **Nova Palavra:**\n\n"
        text += f"üáßüá∑ **Portugu√™s:** {lesson['pt']}\n"
        text += f"üá∫üá∏ **Ingl√™s:** {lesson['en']}\n"
        
        if lesson.get('pronunciation'):
            text += f"üó£Ô∏è **Pron√∫ncia:** {lesson['pronunciation']}\n"
        
        if lesson.get('explanation'):
            text += f"\nüí° **Explica√ß√£o:** {lesson['explanation']}\n"
        
        if lesson.get('example_pt') and lesson.get('example_en'):
            text += f"\nüìù **Exemplo:**\n"
            text += f"PT: {lesson['example_pt']}\n"
            text += f"EN: {lesson['example_en']}\n"
        
        if lesson.get('tips'):
            text += f"\nüéØ **Dica:** {lesson['tips']}"
        
        return text

# Inst√¢ncia global para f√°cil acesso
lesson_manager = LessonManager()
content_helper = ContentHelper()